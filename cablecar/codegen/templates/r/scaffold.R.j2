# {{ study_name }} - Reproducible Analysis Script
# Generated by CableCar v2
# Schema: {{ schema_name }}

# =============================================================================
# Libraries
# =============================================================================

library(tidyverse)
library(broom)
{% set needs_survival = [] %}
{% for step in steps %}
{% if step.analysis_type == "survival" %}
{% if needs_survival.append(1) %}{% endif %}
{% endif %}
{% endfor %}
{% if needs_survival %}
library(survival)
library(survminer)
{% endif %}

# =============================================================================
# Configuration
# =============================================================================

args <- commandArgs(trailingOnly = TRUE)
data_dir <- if (length(args) >= 1) args[1] else "{{ data_source }}"
output_dir <- if (length(args) >= 2) args[2] else "./output"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

# =============================================================================
# Data Loading
# =============================================================================

load_data <- function(data_dir) {
  tables <- list()
  {% for table in tables %}
  path <- file.path(data_dir, "{{ table }}.{{ file_ext }}")
  if (file.exists(path)) {
    {% if file_ext == "parquet" %}
    tables[["{{ table }}"]] <- arrow::read_parquet(path)
    {% else %}
    tables[["{{ table }}"]] <- read_csv(path, show_col_types = FALSE)
    {% endif %}
    cat(sprintf("  Loaded {{ table }}: %d rows\n", nrow(tables[["{{ table }}"]])))
  } else {
    cat(sprintf("  WARNING: {{ table }}.{{ file_ext }} not found, skipping\n"))
  }
  {% endfor %}
  tables
}

# =============================================================================
# Cohort Definition
# =============================================================================

build_cohort <- function(tables) {
  cohort <- tables[["hospitalization"]]
  cat(sprintf("\nStarting population: %d\n", nrow(cohort)))
  {% if cohort %}
  {% for criterion in cohort.get("inclusion", []) %}

  # Include: {{ criterion.column }} {{ criterion.op }} {{ criterion.value }}
  n_before <- nrow(cohort)
  {% if criterion.value is string %}
  cohort <- cohort %>% filter({{ criterion.column }} {{ criterion.op }} "{{ criterion.value }}")
  {% else %}
  cohort <- cohort %>% filter({{ criterion.column }} {{ criterion.op }} {{ criterion.value }})
  {% endif %}
  cat(sprintf("  After {{ criterion.column }} {{ criterion.op }} {{ criterion.value }}: %d (dropped %d)\n",
              nrow(cohort), n_before - nrow(cohort)))
  {% endfor %}
  {% for criterion in cohort.get("exclusion", []) %}

  # Exclude: {{ criterion.column }} {{ criterion.op }} {{ criterion.value }}
  n_before <- nrow(cohort)
  {% if criterion.value is string %}
  cohort <- cohort %>% filter(!({{ criterion.column }} {{ criterion.op }} "{{ criterion.value }}"))
  {% else %}
  cohort <- cohort %>% filter(!({{ criterion.column }} {{ criterion.op }} {{ criterion.value }}))
  {% endif %}
  cat(sprintf("  After excluding {{ criterion.column }} {{ criterion.op }} {{ criterion.value }}: %d (dropped %d)\n",
              nrow(cohort), n_before - nrow(cohort)))
  {% endfor %}
  {% endif %}

  cat(sprintf("\nFinal cohort: %d subjects\n", nrow(cohort)))
  cohort
}

# =============================================================================
# Analysis Steps
# =============================================================================
{% for step in steps %}

{{ step.name | replace("-", "_") | replace(" ", "_") }} <- function(cohort, tables) {
  # {{ step.description }}
  # Analysis type: {{ step.analysis_type }}
  {% for key, val in step.parameters.items() %}
  # {{ key }}: {{ val }}
  {% endfor %}
  # TODO: Implement {{ step.analysis_type }} analysis
  stop("Fill in analysis code")
}
{% endfor %}

# =============================================================================
# Main
# =============================================================================

cat(strrep("=", 60), "\n")
cat("{{ study_name }}\n")
cat(strrep("=", 60), "\n")

cat("\nLoading data...\n")
tables <- load_data(data_dir)

cohort <- build_cohort(tables)
{% for step in steps %}

cat(sprintf("\n--- {{ step.name }} ---\n"))
{{ step.name | replace("-", "_") | replace(" ", "_") }}(cohort, tables)
{% endfor %}

cat("\nAnalysis complete\n")
