"""
{{ study_name }} - Reproducible Analysis Script
Generated by CableCar v2
Schema: {{ schema_name }}
"""
import argparse
from pathlib import Path

import pandas as pd
import numpy as np
{% set needs_scipy = [] %}
{% set needs_statsmodels = [] %}
{% set needs_lifelines = [] %}
{% set needs_sklearn = [] %}
{% for step in steps %}
{% if step.analysis_type in ["descriptive", "hypothesis"] %}
{% if needs_scipy.append(1) %}{% endif %}
{% endif %}
{% if step.analysis_type == "regression" %}
{% if needs_statsmodels.append(1) %}{% endif %}
{% endif %}
{% if step.analysis_type == "survival" %}
{% if needs_lifelines.append(1) %}{% endif %}
{% endif %}
{% if step.analysis_type == "prediction" %}
{% if needs_sklearn.append(1) %}{% endif %}
{% endif %}
{% endfor %}
{% if needs_scipy %}
from scipy import stats
{% endif %}
{% if needs_statsmodels %}
import statsmodels.api as sm
{% endif %}
{% if needs_lifelines %}
from lifelines import KaplanMeierFitter, CoxPHFitter
from lifelines.statistics import logrank_test
{% endif %}
{% if needs_sklearn %}
from sklearn.model_selection import train_test_split
from sklearn.metrics import roc_auc_score, average_precision_score
{% endif %}


# =============================================================================
# Configuration
# =============================================================================

def parse_args():
    parser = argparse.ArgumentParser(description="{{ study_name }}")
    parser.add_argument("--data-dir", type=str, default="{{ data_source }}",
                        help="Path to directory with CLIF-formatted {{ file_ext }} files")
    parser.add_argument("--output-dir", type=str, default="./output",
                        help="Path for output files")
    return parser.parse_args()


# =============================================================================
# Data Loading
# =============================================================================

def load_data(data_dir: Path) -> dict[str, pd.DataFrame]:
    """Load CLIF tables from {{ file_ext }} files."""
    tables = {}
    {% for table in tables %}
    path = data_dir / "{{ table }}.{{ file_ext }}"
    if path.exists():
        tables["{{ table }}"] = pd.{{ read_fn }}(path)
        print(f"  Loaded {{ table }}: {len(tables['{{ table }}'])} rows")
    else:
        print(f"  WARNING: {{ table }}.{{ file_ext }} not found, skipping")
    {% endfor %}
    return tables


# =============================================================================
# Cohort Definition
# =============================================================================

def build_cohort(tables: dict[str, pd.DataFrame]) -> pd.DataFrame:
    """Apply inclusion/exclusion criteria to define the study cohort."""
    cohort = tables["hospitalization"].copy()
    print(f"\nStarting population: {len(cohort)}")
    {% if cohort %}
    {% for criterion in cohort.get("inclusion", []) %}

    # Include: {{ criterion.column }} {{ criterion.op }} {{ criterion.value }}
    n_before = len(cohort)
    {% if criterion.value is string %}
    cohort = cohort[cohort["{{ criterion.column }}"] {{ criterion.op }} "{{ criterion.value }}"]
    {% else %}
    cohort = cohort[cohort["{{ criterion.column }}"] {{ criterion.op }} {{ criterion.value }}]
    {% endif %}
    print(f"  After {{ criterion.column }} {{ criterion.op }} {{ criterion.value }}: {len(cohort)} (dropped {n_before - len(cohort)})")
    {% endfor %}
    {% for criterion in cohort.get("exclusion", []) %}

    # Exclude: {{ criterion.column }} {{ criterion.op }} {{ criterion.value }}
    n_before = len(cohort)
    {% if criterion.value is string %}
    cohort = cohort[~(cohort["{{ criterion.column }}"] {{ criterion.op }} "{{ criterion.value }}")]
    {% else %}
    cohort = cohort[~(cohort["{{ criterion.column }}"] {{ criterion.op }} {{ criterion.value }})]
    {% endif %}
    print(f"  After excluding {{ criterion.column }} {{ criterion.op }} {{ criterion.value }}: {len(cohort)} (dropped {n_before - len(cohort)})")
    {% endfor %}
    {% endif %}

    print(f"\nFinal cohort: {len(cohort)} subjects")
    return cohort


# =============================================================================
# Analysis Steps
# =============================================================================
{% for step in steps %}

def {{ step.name | replace("-", "_") | replace(" ", "_") }}(cohort: pd.DataFrame, tables: dict[str, pd.DataFrame]):
    """{{ step.description }}

    Analysis type: {{ step.analysis_type }}
    {% for key, val in step.parameters.items() %}
    {{ key }}: {{ val }}
    {% endfor %}
    """
    # TODO: Implement {{ step.analysis_type }} analysis
    # Parameters: {{ step.parameters }}
    raise NotImplementedError("Fill in analysis code")
{% endfor %}


# =============================================================================
# Main
# =============================================================================

if __name__ == "__main__":
    args = parse_args()
    data_dir = Path(args.data_dir)
    output_dir = Path(args.output_dir)
    output_dir.mkdir(parents=True, exist_ok=True)

    print("=" * 60)
    print("{{ study_name }}")
    print("=" * 60)

    # Load data
    print("\nLoading data...")
    tables = load_data(data_dir)

    # Build cohort
    cohort = build_cohort(tables)
    {% for step in steps %}

    # Step: {{ step.name }}
    print(f"\n--- {{ step.name }} ---")
    {{ step.name | replace("-", "_") | replace(" ", "_") }}(cohort, tables)
    {% endfor %}

    print("\nAnalysis complete")
